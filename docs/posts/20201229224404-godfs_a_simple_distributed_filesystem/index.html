<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
    <head>
        <link href="https://gmpg.org/xfn/11" rel="profile">
        <meta charset="utf-8">
        
        
        

        
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">

        
        <meta name="referrer" content="no-referrer">

        <title>
            
                GoDFS - a simple distributed filesystem ❚ Blog | Rounak Datta
            
        </title>
        
        
        <style>
         body {
             margin: 40px auto;
             max-width: 650px;
             line-height: 1.6;
             font-size: 18px;
             color: #444;
             padding: 0 10px;
         }
         h1, h2, h3 {
             line-height: 1.2;
         }
         .masthead-title {
             font-size: 40px;
             font-weight: bold;
         }
         .masthead-title a {
             text-decoration: none;
         }
         .masthead-body {
             font-size: 0.8em;
         }
         
             /* CSS for Pretty Print for Debug (debugprint.html) */
/* https://github.com/kaushalmodi/hugo-debugprint/blob/master/layouts/partials/debugprint.html */
/* https://github.com/kaushalmodi/hugo-debugprint/blob/master/layouts/partials/debugprint.css */
.debugprint_wrap {
    padding: 20px;
    display: inline-block;
    margin: 10px auto;
    border-radius: 5px;
    border: 2px solid #ddd;
}
.debugprint td, .debugprint th {
    padding-left: 4px;
    padding-right: 4px;
}
.debugprint th {
    border-bottom: 1px solid #ddd;
    padding-bottom: 10px;
    margin-bottom: 10px;
}
.debugprint tr {
    padding: 5px 10px;
}
.debugprint .key {
    font-weight: bold;
}
.debugprint .type {
    /* Hide Type columns in debugprint */
    /* display: none; */
    font-size: 0.9em;
    font-family: monospace;
    font-style: italic;
}
.debugprint .value {
    font-family: monospace;
}
.debugprint .true {
    color: green;
}
.debugprint .false {
    color: red;
}
/* Don't touch the table headers */
.debugprint th.key,
.debugprint th.type,
.debugprint th.value {
    font-family: helvetica, arial, san-serif;
    text-transform: uppercase;
    letter-spacing: 1px;
    font-size: 1em;
    font-style: normal;
}

         
          
         figcaption,
         .src-block-caption,
         .table-caption {
             font-style: italic;
             text-align: center;
         }
         dt {
             font-weight: bold;
         }
         dd {
             margin-bottom: .5rem;
         }
          
         ul.task-list {
             list-style-type: none;
         }
        </style>

        
        
 
<meta property="og:title" content="GoDFS - a simple distributed filesystem" />
<meta property="og:description"
      content="This post is about a simple distributed file system I built in Go. Also, my first org-mode-written, org-roam-published article.
.org-center { margin-left: auto; margin-right: auto; text-align: center; }  Redundancy is the key in software engineering ~Paul Klint
 I&amp;rsquo;ve been midway through Designing Data-Intensive Applications and implementing such a distributed system and its algorithms was always on my stack. This implementation tries to cover most of the important aspects, yet largely simplified." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/20201229224404-godfs_a_simple_distributed_filesystem/" />


    
    










    




         <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="GoDFS - a simple distributed filesystem"/>
<meta name="twitter:description" content="This post is about a simple distributed file system I built in Go. Also, my first org-mode-written, org-roam-published article.
.org-center { margin-left: auto; margin-right: auto; text-align: center; }  Redundancy is the key in software engineering ~Paul Klint
 I&amp;rsquo;ve been midway through Designing Data-Intensive Applications and implementing such a distributed system and its algorithms was always on my stack. This implementation tries to cover most of the important aspects, yet largely simplified."/>


        
        


<script src="js/mathjax-config.js"></script>


<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>



<link rel="stylesheet" href="/css/github_chroma.css" type="text/css" />

    </head>

    <body lang="en">

        

        <div style="float: left;">
            <small>
                <span style="font-variant: small-caps;">.Kind</span> (<strong>page</strong>):
                <span style="font-variant: small-caps;">.Type</span> (<strong>posts</strong>) /
                <span style="font-variant: small-caps;">.Layout</span> (<strong></strong>)

                <br />
                
                
                    
                        
                            
                        
                    
                
                <span style="font-variant: small-caps;">Bundle</span>: <strong>n/a (regular page)</strong>
            </small>
        </div>

        
            <div style="float: right;">
                [
                
                
                    
                         <a href="/categories/">categories</a>
                        
                    
                
                    
                        | <a href="/tags/">tags</a>
                        
                    
                
                
                ]
            </div>
            <div style="clear: both;"></div> 
        

        <div class="masthead-title"><a href="/">Blog | Rounak Datta</a></div>
        <div class="masthead-body">
            
                <p>This is built using <a href="https://github.com/kaushalmodi/ox-hugo">
<code>ox-hugo</code></a> package for Emacs/Org-mode.
</p>
            
            
                <p>It is <b>updated automatically after each commit</b> to the <a href="https://github.com/rounakdatta/rounakdatta.github.io">
                    <code>rounakdatta.github.io</code> repo</a>.
                    It was last updated on <i>Dec 30, 2020 12:54 IST</i>.
                </p>
                <ul>
                    
                    
                        <li><a href="https://github.com/rounakdatta/rounakdatta.github.io/tree/master/public">Markdown source dir</a></li>
                    
                </ul>
            
            <hr>
        </div>

        

        
            
                
                
                    
                        <br />
                        <div style="float: right;">
                            ✱ <i>Markdown <a href="https://github.com/rounakdatta/rounakdatta.github.io/raw/master/public/posts/20201229224404-godfs_a_simple_distributed_filesystem.md">
                            source</a> of this page</i>
                        </div>
                        <div style="clear: both;"></div> 
                    
                
            
        

                       

        

<div class="post">
    <h1 class="post-title">GoDFS - a simple distributed filesystem</h1>

    
    
    
        
            
        
            
        
    

    <p>
        
    </p>

    <hr />
    <h3>Description/Summary</h3>
    
        <p>This post is about a simple distributed file system I built in Go. Also, my first org-mode-written, org-roam-published article.
.org-center { margin-left: auto; margin-right: auto; text-align: center; }  Redundancy is the key in software engineering ~Paul Klint
 I&rsquo;ve been midway through Designing Data-Intensive Applications and implementing such a distributed system and its algorithms was always on my stack. This implementation tries to cover most of the important aspects, yet largely simplified.</p>
    
    <hr />

    



    <h3>Content</h3>
    <p>This post is about a simple distributed file system I built in Go. Also, my first <strong>org-mode</strong>-written, <em>org-roam</em>-published article.</p>
<style>.org-center { margin-left: auto; margin-right: auto; text-align: center; }</style>
<div class="org-center">
  <div></div>
<p>Redundancy is the key in software engineering ~Paul Klint</p>
</div>
<p>I&rsquo;ve been midway through <a href="https://www.goodreads.com/book/show/23463279-designing-data-intensive-applications">Designing Data-Intensive Applications</a> and implementing such a distributed system and its algorithms was always on my stack. This implementation tries to cover most of the important aspects, yet largely simplified.</p>
<p>The source for this project is <a href="https://github.com/rounakdatta/GoDFS">rounakdatta/GoDFS</a>.</p>
<h2 id="building-go-distributed-file-system">Building Go Distributed File System</h2>
<h3 id="abstracting-away-the-odds">Abstracting away the odds</h3>
<p>Proven systems like <a href="https://static.googleusercontent.com/media/research.google.com/en//archive/gfs-sosp2003.pdf">Google FileSystem (GFS)</a> and <a href="https://hadoop.apache.org/docs/r1.2.1/hdfs%5Fdesign.pdf">Hadoop Distributed FileSystem</a> have almost made developers take distributed architectures for granted. We now regularly use open-source systems like the Hadoop ecosystem tools, managed cloud services without worrying of the underlying engineering behind scaling it across machines, data-centers and continents. In this implementation as well, we have abstracted the working of RPC, filesystem storage considerations, thus making it not production-ready.</p>
<figure>
    <img src="/ox-hugo/dynamodb_rant.png"
         alt="Figure 1: Source"/> <figcaption>
            <p>Figure 1: <a href="https://www.jeremydaly.com/takeaways-from-dynamodb-deep-dive-advanced-design-patterns-dat403/">Source</a></p>
        </figcaption>
</figure>

<h3 id="the-pieces">The pieces</h3>
<p>To build a distributed system which stores and serves files on-demand typically needs to have a set of persistent data stores, a coordinating unit and an user-facing dumb client.</p>
<h4 id="datanode">DataNode</h4>
<p>DataNodes in this system are just holding the data and when provided with an address can write data to or read data from that address. The data nodes deal with chunks of data which when aggregated by someone else makes sense. Ideally, the number of data nodes should be greater than one for it to be a distributed system. Also it is not necessary that a single data node would contain every chunk of a particular file.</p>
<h4 id="namenode">NameNode</h4>
<p>The NameNode is ideally a singular central coordinating unit of the entire system. It&rsquo;s responsibilities start from record-keeping of which all data nodes are available/healthy and helping the client decide with where all to put the chunks for an incoming file &amp; where all to fetch the chunks from for a requested file. The name node also knows what is the chunk size (termed BlockSize later) and how many copies of data to keep (ReplicationFactor). The name node is the know-it-all guy of the system and therefore making it&rsquo;s death fatal for the system. Therefore we must have a backup name node (called Secondary NameNode) to which the NameNode is flushing all its meta periodically.</p>
<h4 id="client">Client</h4>
<p>Client does all the talking. Upon the client getting a request from the user interface, it&rsquo;s job is to first contact the NameNode for all the meta information. If it is a file <code>PUT</code> request, name node helps it by providing where all to keep the chunks in (the endpoints of the DataNodes and the target directory path within them). If it is a file <code>GET</code> request, the name node helps it by providing the intrinsic details of where exactly to obtain the chunks from. And thus the loop completes.</p>
<h3 id="the-chunks">The chunks</h3>
<p>We must decide on a BlockSize factor which determines into how many pieces a file is broken into. Of course having this metric too high or low impacts the write and read performances of the system overall, but we need to find a justified value which has been benchmarked. The chunks (henceforth referred to as blocks) are stored as individual files and is indexed by the NameNode through a BlockId. Depending upon ReplicationFactor we might have redundant copies of the same block stored on multiple data nodes.</p>
<h3 id="the-replication">The replication</h3>
<p>Replication is probably the most important factor in this context. We must decide upon the ReplicationFactor considering the cost-reliability trade-off. The replication in this system works as: When the client requests a particular DataNode to write a new block into its file system, the client also supplies with which all data nodes to replicate to. Now as the first data node finishes writing to its own file system, it itself connects to the next replication candidate data node and passes the remaining array of replication candidates. And thus the replication process finishes when the tail of the recursion returns to the client and the replicated file write can be concluded to have succeeded.</p>
<h3 id="the-talking">The talking</h3>
<p>As the client communicates with the NameNode, DataNodes, as the DataNodes whisper to each other, what is the protocol of talking? We are using plain and simple RPC (Remote Procedural Calls) here in this case.</p>
<h2 id="setting-it-up">Setting it up</h2>
<p>You can try GoDFS manually or by setting it up through Docker Compose. We can test and compile it to produce a binary as:</p>
<p><a id="code-snippet--testing and building"></a></p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">make <span class="nb">test</span>
make build
</code></pre></div><h3 id="natively-on-local-host">Natively on local host</h3>
<p>First, we need to set up the DataNode and NameNode daemons, we are starting 3 data nodes for example, and they are running on the same host:</p>
<p><a id="code-snippet--booting datanodes"></a></p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">./godfs datanode --port <span class="m">7000</span> --data-location .dndata1/
./godfs datanode --port <span class="m">7001</span> --data-location .dndata2/
./godfs datanode --port <span class="m">7002</span> --data-location .dndata3/
</code></pre></div><p>Next, we are initializing the NameNode providing it with the list of data nodes available. If not provided explicitly, the NameNode tries discovering services in the local host for a particular range of ports.</p>
<p><a id="code-snippet--booting namenode"></a></p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">./godfs namenode --datanodes localhost:7000,localhost:7001,localhost:7002 --block-size <span class="m">10</span> --replication-factor <span class="m">2</span>
</code></pre></div><p>Now, we are good to try using the client to do the file keeping and fetching operations (let&rsquo;s try with the readme file):</p>
<p><a id="code-snippet--testing client"></a></p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">./godfs client --namenode localhost:9000 --operation put --source-path ./ --filename README.md
<span class="c1"># 2020/08/08 18:08:51 NameNode to connect to is localhost:9000</span>
<span class="c1"># 2020/08/08 18:08:52 Put status: true</span>

./godfs client --namenode localhost:9000 --operation get --filename README.md
<span class="c1"># 2020/08/08 18:09:00 NameNode to connect to is localhost:9000</span>
<span class="c1"># 2020/08/08 18:09:00 Get status: true</span>
<span class="c1"># FILE CONTENTS ...</span>
</code></pre></div><h3 id="containerized-through-docker-compose">Containerized through Docker Compose</h3>
<p>In the <code>docker-compose.yml</code> file, we try to define the DataNode and NameNode as independent services and the requested number of instances of the same will be spawned up. We have individual <code>Dockerfile</code> s for the DataNode and NameNode.</p>
<p>Assuming we have Docker set up in the host system, we have to build the images first:</p>
<p><a id="code-snippet--building docker images"></a></p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">docker build -t datanode -f daemon/datanode/Dockerfile .
docker build -t namenode -f daemon/namenode/Dockerfile .
docker build -t client -f daemon/client/Dockerfile .
</code></pre></div><p>Now we can initiate a desired number of containers for DataNode and a single container for NameNode as:</p>
<p><a id="code-snippet--booting the composed containers"></a></p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">docker-compose up --scale <span class="nv">datanode</span><span class="o">=</span><span class="m">6</span> --remove-orphans --force-recreate
</code></pre></div><p>Next, we would need a client in the same network to test out requests:</p>
<p><a id="code-snippet--interacting through a client container"></a></p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">docker run -it --network host client
</code></pre></div><blockquote>
<p>TODO: Here we have allowed the DataNode containers to run within the <strong>host</strong> network, i.e. its processes are now exposed to the host. We need some more sophistication in the isolation here.</p>
</blockquote>
<p>Either way of testing, to test the end-to-end working of the system, we not only want <code>GET</code> Success, but also want to understand when such a DFS can fail. We can fetch the metadata from the NameNode on where all the blocks of a given file are kept. So, theoretically, if <code>replication-factor</code> is 2 and we identify those 2 DataNodes for a particular file BlockId, we can then experiment with the edge cases of distributed systems by killing those two containers. And then we should no longer be able to fetch the complete file (since a part of it does not exist in any of the data nodes). If practice matches the above theory, we are good to go :)!</p>


    
        

        

        <hr />
        <a id="debug"></a>
        <h3 id="page-debug">Page (Debug)</h3>
        









 
 






 








    <div class="debugprint_wrap">
         
            
            
            <table class="debugprint">
                <tr><th class="key">Page Variable</th><th class="value">Value</th></tr>
                
                    <tr><td class="key">Name</td><td class="value">
                    









 
 






 








    
    &#34;GoDFS - a simple distributed filesystem&#34;








 
                    </td></tr>
                
                    <tr><td class="key">Title</td><td class="value">
                    









 
 






 








    
    &#34;GoDFS - a simple distributed filesystem&#34;








 
                    </td></tr>
                
                    <tr><td class="key">ResourceType</td><td class="value">
                    









 
 






 








    
    &#34;page&#34;








 
                    </td></tr>
                
                    <tr><td class="key">Kind</td><td class="value">
                    









 
 






 








    
    &#34;page&#34;








 
                    </td></tr>
                
                    <tr><td class="key">Section</td><td class="value">
                    









 
 






 








    
    &#34;posts&#34;








 
                    </td></tr>
                
                    <tr><td class="key">Draft</td><td class="value">
                    









 
 






 








    <span class="debugprint"><span class="false">false</span></span>








 
                    </td></tr>
                
                    <tr><td class="key">Type</td><td class="value">
                    









 
 






 








    
    &#34;posts&#34;








 
                    </td></tr>
                
                    <tr><td class="key">Layout</td><td class="value">
                    









 
 






 








    
    &#34;&#34;








 
                    </td></tr>
                
                    <tr><td class="key">Permalink</td><td class="value">
                    









 
 






 








    
    &#34;/posts/20201229224404-godfs_a_simple_distributed_filesystem/&#34;








 
                    </td></tr>
                
                    <tr><td class="key">RelPermalink</td><td class="value">
                    









 
 






 








    
    &#34;/posts/20201229224404-godfs_a_simple_distributed_filesystem/&#34;








 
                    </td></tr>
                
                    <tr><td class="key">Data</td><td class="value">
                    









 
 






 








     <div class="debugprint_wrap">
        <table class="debugprint">
            <tr><td>page.Data{} (<i>type:page.Data</i>)</td></tr>
        </table>
    </div>








 
                    </td></tr>
                
                
                    <tr><td class="key">NextPage</td><td class="value">None</td></tr>
                
                
                    <tr><td class="key">PrevPage</td><td class="value">None</td></tr>
                
                
                    <tr><td class="key">NextInSection</td><td class="value">None</td></tr>
                
                
                    <tr><td class="key">PrevInSection</td><td class="value">None</td></tr>
                
            </table>
        
    </div>









        <h3 id="page-params-debug">Page Params (Debug)</h3>
        









 
 






 








    
        <div class="debugprint_wrap">
            <table class="debugprint">
                <tr><th class="key">Key</th><th class="type">Type</th><th class="value">Value</th></tr>
                
                    
                    
                    
                        <tr><td class="key">author</td><td class="type">[]string</td><td class="value">
                        









 
 






 








    
        









 
 






 








    
    &#34;Rounak Datta&#34;








 
    








 
                        </td></tr>
                    
                
                    
                    
                    
                        <tr><td class="key">draft</td><td class="type">bool</td><td class="value">
                        









 
 






 








    <span class="debugprint"><span class="false">false</span></span>








 
                        </td></tr>
                    
                
                    
                    
                    
                        <tr><td class="key">iscjklanguage</td><td class="type">bool</td><td class="value">
                        









 
 






 








    <span class="debugprint"><span class="false">false</span></span>








 
                        </td></tr>
                    
                
                    
                    
                    
                        <tr><td class="key">title</td><td class="type">string</td><td class="value">
                        









 
 






 








    
    &#34;GoDFS - a simple distributed filesystem&#34;








 
                        </td></tr>
                    
                
            </table>
        </div>
    









        
        <h3 id="file-debug">File Object (Debug)</h3>
        









 
 






 








    <div class="debugprint_wrap">
        
            
            
            
            
            <table class="debugprint">
                <tr><th class="key">FileInfo Variable</th><th class="value">Value</th></tr>
                
                    <tr><td class="key">UniqueID</td><td class="value">
                    









 
 






 








    
    &#34;28a13ae4fabf30d0f3b4e40e9675c82d&#34;








 
                    </td></tr>
                
                    <tr><td class="key">BaseFileName</td><td class="value">
                    









 
 






 








    
    &#34;20201229224404-godfs_a_simple_distributed_filesystem&#34;








 
                    </td></tr>
                
                    <tr><td class="key">TranslationBaseName</td><td class="value">
                    









 
 






 








    
    &#34;20201229224404-godfs_a_simple_distributed_filesystem&#34;








 
                    </td></tr>
                
                    <tr><td class="key">Lang</td><td class="value">
                    









 
 






 








    
    &#34;en&#34;








 
                    </td></tr>
                
                    <tr><td class="key">Section</td><td class="value">
                    









 
 






 








    
    &#34;posts&#34;








 
                    </td></tr>
                
                    <tr><td class="key">LogicalName</td><td class="value">
                    









 
 






 








    
    &#34;20201229224404-godfs_a_simple_distributed_filesystem.md&#34;








 
                    </td></tr>
                
                    <tr><td class="key">Dir</td><td class="value">
                    









 
 






 








    
    &#34;posts/&#34;








 
                    </td></tr>
                
                    <tr><td class="key">Ext</td><td class="value">
                    









 
 






 








    
    &#34;md&#34;








 
                    </td></tr>
                
                    <tr><td class="key">Path</td><td class="value">
                    









 
 






 








    
    &#34;posts/20201229224404-godfs_a_simple_distributed_filesystem.md&#34;








 
                    </td></tr>
                
            </table>
        
    </div>









    
</div>



        <hr>
        <small>This site is generated using the
            
            <a href="https://github.com/kaushalmodi/hugo-bare-min-theme"><code>hugo-bare-min-theme</code></a> + Hugo <b>0.79.1</b>
            .
        </small>
        <div style="text-align: center;">
  [<a href="/">Rounak's Blog</a> | <a href="https://ox-hugo.scripter.co/"><code>ox-hugo</code> home</a>]
</div>

        
    </body>
</html>


